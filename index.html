<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>P1 – Anfitrión (LLM + MCP)</title>
  <style>
    :root{
      --bg:#0b1222; --bg2:#0f1a33; --card:#0d1530cc; --card2:#0e1737cc;
      --glass:#ffffff10; --border:#ffffff25; --text:#eaf0fb; --muted:#9bb0c9;
      --pri:#6aa3ff; --ok:#59c4b8; --danger:#ff6b6b;
      --shadow:0 18px 44px rgba(0,0,0,.35), 0 2px 0 rgba(255,255,255,.03) inset;
      --mono: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
      --round: 16px;
    }
    @media (prefers-color-scheme:light){
      :root{
        --bg:#f5f7fb; --bg2:#e9eef7; --card:#ffffffea; --card2:#ffffffee;
        --glass:#00000006; --border:#00000012; --text:#0f1628; --muted:#5c687d;
        --shadow:0 14px 30px rgba(10,20,40,.12);
      }
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; color:var(--text); font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(1200px 700px at 10% -10%, #1a2a55 0%, transparent 60%),
                  radial-gradient(900px 600px at 90% 10%, #12334f 0%, transparent 55%),
                  linear-gradient(180deg,var(--bg),var(--bg2));
      min-height:100%;
    }
    .wrap{max-width:1200px;margin:28px auto;padding:0 20px 60px}

    /* Header */
    .hdr{display:flex;gap:14px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .brand{
      display:flex;gap:12px;align-items:center;padding:12px 14px;border-radius:14px;
      background:var(--card); border:1px solid var(--border); box-shadow:var(--shadow); backdrop-filter:blur(8px)
    }
    .logo{width:36px;height:36px;border-radius:12px;
      background:conic-gradient(from 220deg,var(--ok),var(--pri) 60%,var(--ok));
      box-shadow:0 4px 18px rgba(90,160,255,.35)}
    .brand h1{margin:0;font-size:18px;font-weight:700;letter-spacing:.2px}
    .pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px;color:var(--muted);background:var(--glass)}

    /* Controls */
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--round);padding:14px;box-shadow:var(--shadow)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    select,button,textarea{
      font:inherit;border:1px solid var(--border);border-radius:12px;background:#ffffff0a;color:var(--text);padding:10px 12px
    }
    select{backdrop-filter:blur(6px)}
    button{cursor:pointer;transition:transform .05s ease,opacity .15s ease}
    button:active{transform:translateY(1px)}
    .ghost{background:#ffffff10}
    .primary{background:linear-gradient(180deg,var(--ok),#0d8e83);border-color:#0d8e83;color:#fff}
    .danger{background:linear-gradient(180deg,#ff8484,#ff6b6b);border-color:#ff6b6b;color:#fff}

    /* Layout principal 60/40 */
    .grid{
      display:grid;
      grid-template-columns: minmax(0,3fr) minmax(0,2fr); /* 60/40 */
      gap:20px;
      margin-top:16px;
      align-items:start;
    }
    @media (max-width:1024px){ .grid{ grid-template-columns:1fr; } }

    /* Paneles */
    .pane{background:var(--card2);border:1px solid var(--border);border-radius:var(--round);padding:14px;box-shadow:var(--shadow)}
    .pane h2{margin:0 0 10px;font-size:15px;color:var(--muted);letter-spacing:.2px}

    /* Chat */
    .messages{display:flex;flex-direction:column;gap:12px;min-height:280px;max-height:480px;overflow:auto;padding:6px 6px 6px 2px}
    .bubble{display:flex;gap:10px;align-items:flex-start;animation:pop .15s ease}
    @keyframes pop{from{transform:translateY(2px);opacity:.0}to{transform:none;opacity:1}}
    .avatar{
      width:34px;height:34px;border-radius:50%;
      background:radial-gradient(120% 120% at 30% 20%,#fff8,#0000),linear-gradient(135deg,#7aa7ff,#a6e6ff);
      box-shadow:0 2px 10px rgba(0,0,0,.25);flex:0 0 34px
    }
    .avatar.host{background:radial-gradient(120% 120% at 30% 20%,#fff8,#0000),linear-gradient(135deg,#58d0c4,#3fb3a8)}
    .msg{
      flex:1;padding:12px 14px;border-radius:14px;border:1px solid var(--border);
      background:#0f1e3f; white-space:pre-wrap; font-family:var(--mono); font-size:14px; line-height:1.45;
      box-shadow:0 2px 0 #ffffff05 inset;
    }
    .msg.host{background:#0f2a4a}
    .meta{font-size:12px;color:var(--muted);margin-top:4px}
    .composer{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    #msg{min-height:110px;resize:vertical;background:#0f1b37;border-color:#263253}
    .composer .row{justify-content:flex-end}

    /* Panel derecho */
    pre{
      background:#0a1228; color:#e6edf3; padding:14px; border-radius:12px; border:1px solid #1b2746;
      overflow:auto; max-height:360px; font-size:13px; line-height:1.48; box-shadow:var(--shadow)
    }
    #log{display:flex;flex-direction:column;gap:10px;max-height:240px;overflow:auto}
    .logline{
      font-family:var(--mono); font-size:12px; color:#a9b7d0; white-space:pre-wrap;
      background:#00000012; border:1px dashed var(--border); padding:10px; border-radius:10px
    }

    /* Chips */
    .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:var(--glass);color:var(--muted)}
    .chip .dot{width:8px;height:8px;border-radius:50%;background:var(--ok);box-shadow:0 0 0 2px #0003}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <div class="hdr">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1>P1 – Anfitrión (LLM + MCP)</h1>
      </div>
      <span class="pill" id="ctxInfo">ctx: -</span>
    </div>

    <!-- Controls -->
    <div class="card">
      <div class="row">
        <div class="row" style="gap:8px">
          <span class="pill">Servidor</span>
          <select id="serverSelect"></select>
        </div>
        <span class="chip"><span class="dot"></span>Modo: Asistente (LLM+MCP)</span>
        <button id="btnNew" class="ghost">Nueva sesión</button>
        <button id="btnExport" class="ghost">Exportar</button>
      </div>
    </div>

    <!-- Main -->
    <div class="grid">
      <!-- Izquierda: Chat -->
      <div class="pane">
        <h2>Conversación</h2>
        <div id="messages" class="messages"></div>
        <div class="composer">
          <textarea id="msg" placeholder='Escribe en lenguaje natural (ej.: "crea carpeta p1-demo", "lista p1-demo", "¿qué herramientas hay?")'></textarea>
          <div class="row">
            <button id="btnSend" class="primary">Enviar</button>
          </div>
        </div>
      </div>

      <!-- Derecha: Detalles -->
      <div class="pane">
        <h2>Request / Response</h2>
        <pre id="io">{}</pre>
        <h2 style="margin-top:14px">Log de interacciones</h2>
        <div id="log"></div>
      </div>
    </div>
  </div>

  <!-- Tu lógica existente -->
  <script src="./core.js"></script>
  <script src="./app.js"></script>

  <!-- Helpers UI -->
  <script>
    // Render de burbuja (usuario/servidor)
    window.renderBubble = function(role, text){
      const list = document.getElementById('messages');
      const row  = document.createElement('div'); row.className = 'bubble';
      const ava  = document.createElement('div'); ava.className = 'avatar ' + (role==='host'?'host':'server');
      const box  = document.createElement('div');
      const msg  = document.createElement('div'); msg.className = 'msg ' + (role==='host'?'host':''); msg.textContent = text || '';
      const meta = document.createElement('div'); meta.className = 'meta';
      meta.textContent = (role==='host'?'Tú':'Servidor') + ' • ' + new Date().toLocaleTimeString();
      box.appendChild(msg); box.appendChild(meta); row.appendChild(ava); row.appendChild(box);
      list.appendChild(row); list.scrollTop = list.scrollHeight;
    };

    window.appendLog = function(line){
      const log = document.getElementById('log');
      const d = document.createElement('div');
      d.className='logline'; d.textContent=line;
      log.appendChild(d); log.scrollTop=log.scrollHeight;
    };

    // Burbuja del usuario al enviar (sin tocar app.js)
    (function bootstrapUserBubbles(){
      const btn = document.getElementById('btnSend');
      const ta  = document.getElementById('msg');
      if(!btn || !ta) return;
      btn.addEventListener('click', ()=> {
        const t = (ta.value||'').trim();
        if(t) window.renderBubble('host', t);
      });
    })();

    // ---- Espejo: copia la respuesta del panel #io al chat izquierdo ----
    (function mirrorServerBubbles(){
      const io = document.getElementById('io');
      if (!io) return;

      let lastHash = '';
      function hash(s){ let h=0; for(let i=0;i<s.length;i++){ h=(h*31 + s.charCodeAt(i))|0; } return String(h); }

      function extractDisplayText(raw){
        if (!raw) return null;

        // 1) JSON válido (MCP/LLM)
        try {
          const j = JSON.parse(raw);
          if (Array.isArray(j?.content) && j.content.length){
            const text = j.content.map(x => x?.text || '').filter(Boolean).join('\n').trim();
            if (text) return text;
          }
          if (typeof j?.reply === 'string') return j.reply.trim();
          if (typeof j?.text  === 'string') return j.text.trim();
        } catch(_) {}

        // 2) Campos embebidos en texto
        const m1 = raw.match(/"reply"\s*:\s*"([^"]{1,4000})"/s);
        if (m1) { try { return JSON.parse('"'+m1[1]+'"'); } catch(_) {} }
        const m2 = raw.match(/"text"\s*:\s*"([^"]{1,4000})"/s);
        if (m2) { try { return JSON.parse('"'+m2[1]+'"'); } catch(_) {} }

        // 3) Bloque legible (viñetas/lineas útiles)
        const lines = raw.split(/\r?\n/).map(l=>l.trimEnd()).filter(Boolean);
        const startIdx = lines.findIndex(l => /^[-–—•*]|\u2022/.test(l) || /^[A-Za-z0-9_].{12,}$/.test(l));
        const block = (startIdx>=0 ? lines.slice(startIdx) : lines).slice(0, 40);
        if (block.length) return block.join('\n').trim();

        // 4) Fallback corto
        return raw.slice(0, 1200).trim();
      }

      const obs = new MutationObserver(()=>{
        const raw  = io.textContent || '';
        const text = extractDisplayText(raw);
        if (!text) return;
        const h = hash(text);
        if (h === lastHash) return;    // evita duplicados
        lastHash = h;
        if (window.renderBubble) window.renderBubble('server', text);
      });

      obs.observe(io, { childList:true, characterData:true, subtree:true });
    })();
  </script>
</body>
</html>